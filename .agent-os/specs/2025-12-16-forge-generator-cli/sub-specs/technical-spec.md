# Technical Specification

This is the technical specification for the spec detailed in @.agent-os/specs/2025-12-16-forge-generator-cli/spec.md

## Architectural Decisions

### Leverage Existing Ecosystem

| Need | Package | Why Not Reinvent |
|------|---------|------------------|
| **Immutable Data & Unions** | `freezed` | Pattern matching, copyWith, equality |
| **Dart File Parsing** | `analyzer` | Official Dart team package, handles all edge cases |
| **Code Generation Pipeline** | `build_runner` | Standard Flutter codegen tool |
| **Annotation Processing** | `source_gen` | Integrates with build_runner |
| **Code Building** | `code_builder` | Programmatic AST construction |
| **Code Formatting** | `dart_style` | Official Dart formatter |
| **CLI Framework** | `args` + `mason_logger` | Pretty output, progress bars |
| **File System** | `path` + `file` | Cross-platform file handling |

### Functional Programming Approach

```dart
// Use Freezed for all data models
@freezed
class ButtonTokens with _$ButtonTokens {
  const factory ButtonTokens({
    required Color bgColor,
    required Color textColor,
    required double radius,
    required EdgeInsets padding,
  }) = _ButtonTokens;
}

// Use Freezed unions for variants
@freezed
class ButtonVariant with _$ButtonVariant {
  const factory ButtonVariant.primary() = _Primary;
  const factory ButtonVariant.secondary() = _Secondary;
  const factory ButtonVariant.outline({@Default(1.0) double borderWidth}) = _Outline;
}

// Pattern matching in renderers
Widget build(ButtonVariant variant) {
  return variant.when(
    primary: () => _buildPrimary(),
    secondary: () => _buildSecondary(),
    outline: (borderWidth) => _buildOutline(borderWidth),
  );
}
```

## Project Structure

```
generator/
├── bin/
│   └── forge.dart              # CLI entry point
├── lib/
│   ├── src/
│   │   ├── cli/                # Command parsing (args)
│   │   ├── parser/             # Meta file parsing (analyzer)
│   │   ├── generator/          # Code generation (code_builder)
│   │   ├── models/             # Data models (freezed)
│   │   └── utils/              # File handling (path, file)
│   └── forge.dart              # Library exports
├── pubspec.yaml
└── test/
```

## Dependencies

```yaml
# generator/pubspec.yaml
name: forge
description: Forge UI code generator

environment:
  sdk: '>=3.2.0 <4.0.0'

dependencies:
  # CLI
  args: ^2.4.0
  mason_logger: ^0.2.0
  
  # Parsing
  analyzer: ^6.4.0
  
  # Code Generation
  code_builder: ^4.10.0
  dart_style: ^2.3.0
  
  # Data Models
  freezed_annotation: ^2.4.0
  
  # File System
  path: ^1.8.0
  file: ^7.0.0

dev_dependencies:
  # Build
  build_runner: ^2.4.0
  freezed: ^2.4.0
  
  # Testing
  test: ^1.24.0
  mocktail: ^1.0.0
  lints: ^3.0.0
```

## Generated Code Structure

```dart
// ============================================
// GENERATED BY FORGE v0.1.0
// DO NOT MODIFY - Regenerated on build
// Source: meta/button.meta.dart
// ============================================

import 'package:flutter/material.dart';
import 'package:freezed_annotation/freezed_annotation.dart';

part 'app_button.freezed.dart';

@freezed
class ButtonVariant with _$ButtonVariant {
  const factory ButtonVariant.primary() = _Primary;
  const factory ButtonVariant.secondary() = _Secondary;
}

class AppButton extends StatelessWidget {
  final String label;
  final ButtonVariant variant;
  final VoidCallback? onPressed;
  
  const AppButton({
    super.key, 
    required this.label,
    this.variant = const ButtonVariant.primary(),
    this.onPressed,
  });
  
  @override
  Widget build(BuildContext context) {
    final tokens = ForgeTheme.of(context).button;
    
    return variant.when(
      primary: () => _buildButton(tokens.primary),
      secondary: () => _buildButton(tokens.secondary),
    );
  }
  
  Widget _buildButton(ButtonTokens tokens) {
    return GestureDetector(
      onTap: onPressed,
      child: Container(
        padding: tokens.padding,
        decoration: BoxDecoration(
          color: tokens.bgColor,
          borderRadius: BorderRadius.circular(tokens.radius),
        ),
        child: Text(label, style: TextStyle(color: tokens.textColor)),
      ),
    );
  }
}
```

## Performance Targets

- Build time: < 2s for 10 components
- Memory: < 100MB during generation
- Generated code: Zero runtime overhead

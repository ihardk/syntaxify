# Technical Specifications

> System constraints, generator CLI specs, and safety mechanisms.

---

## 1. Core Constraints

### 1.1 The "No Runtime Magic" Rule
Generated code MUST be:
- Readable Flutter code
- Standalone (works if generator is deleted)
- No runtime interpretation of meta files
- No performance overhead from abstraction

### 1.2 Generated Code Requirements
- All generated files include header comment with source info
- Files are properly formatted (dart format compliant)
- No dynamic typing in generated code
- Type-safe API surface

---

## 2. Generator CLI Specification

### 2.1 Commands

| Command | Description |
|---------|-------------|
| `forge build` | Generate all components |
| `forge build --theme=neo` | Generate for specific theme |
| `forge build --component=button` | Generate single component |
| `forge watch` | Watch mode, regenerate on change |
| `forge clean` | Remove all generated files |
| `forge list` | List all defined components |
| `forge inspect <name>` | Show component details |
| `forge migrate` | Run schema migrations |
| `forge doctor` | Check system health |

### 2.2 Flags

| Flag | Description |
|------|-------------|
| `--mode=static` | Inline tokens (max performance) |
| `--mode=dynamic` | Runtime token resolution |
| `--force` | Overwrite modified files |
| `--verbose` | Detailed output |
| `--quiet` | Errors only |
| `--dry-run` | Preview without writing |

### 2.3 Configuration File

```yaml
# forge.yaml
version: 1
output_dir: lib/generated
meta_dir: meta
themes:
  - material
  - cupertino
  - neo
default_theme: material
mode: dynamic
```

---

## 3. Input/Output Specification

### 3.1 Meta File Format

```dart
// meta/button.meta.dart
@MetaComponent()
class ButtonMeta {
  @Required()
  final String label;
  
  @Optional()
  final VoidCallback? onPressed;
  
  @Variant(['primary', 'secondary', 'ghost'])
  final String variant;
  
  @State(['normal', 'loading', 'disabled'])
  final String state;
}
```

### 3.2 Token File Format

```dart
// meta/button.tokens.dart
class ButtonTokens {
  final double radius;
  final Color bgColor;
  final Color textColor;
  final EdgeInsets padding;
  // ...
}

class ButtonTokensLibrary {
  static ButtonTokens material() => ButtonTokens(...);
  static ButtonTokens cupertino() => ButtonTokens(...);
  static ButtonTokens neo() => ButtonTokens(...);
}
```

### 3.3 Output Structure

```
lib/
├── generated/
│   ├── components/
│   │   ├── app_button.dart
│   │   ├── app_input.dart
│   │   └── app_card.dart
│   ├── theme/
│   │   ├── app_theme.dart
│   │   └── app_tokens.dart
│   └── index.dart
```

---

## 4. Generated File Format

```dart
// ============================================================
// GENERATED BY Forge v1.0.0
// DO NOT EDIT MANUALLY
// 
// Source:   meta/button.meta.dart
// Theme:    material
// Generated: 2024-12-16T12:30:00Z
// Checksum:  a1b2c3d4
// ============================================================

import 'package:flutter/material.dart';
import '../theme/app_theme.dart';

class AppButton extends StatelessWidget {
  final String label;
  final VoidCallback? onPressed;
  
  const AppButton({
    super.key,
    required this.label,
    this.onPressed,
  });
  
  @override
  Widget build(BuildContext context) {
    final tokens = AppTheme.of(context).button;
    return GestureDetector(
      onTap: onPressed,
      child: Container(
        padding: tokens.padding,
        decoration: BoxDecoration(
          color: tokens.bgColor,
          borderRadius: BorderRadius.circular(tokens.radius),
        ),
        child: Text(label, style: TextStyle(color: tokens.textColor)),
      ),
    );
  }
}
```

---

## 5. Safety Mechanisms

### 5.1 Overwrite Protection
- Checksum stored in file header
- If user modifies file, checksum changes
- Generator warns before overwriting modified files

### 5.2 Validation Checks
| Check | When |
|-------|------|
| Required tokens present | Build time |
| Type correctness | Build time |
| Accessibility compliance | Build time (optional) |
| Circular dependencies | Build time |

### 5.3 Error Categories
| Code | Category |
|------|----------|
| META-001 | Missing required token |
| META-002 | Invalid token type |
| META-003 | Unknown component |
| META-004 | Schema version mismatch |
| META-005 | File conflict |

---

## 6. Build Integration

### 6.1 build_runner Integration
```yaml
# pubspec.yaml
dev_dependencies:
  build_runner: ^2.4.0
  forge: ^1.0.0
```

```bash
# Run via build_runner
dart run build_runner build
```

### 6.2 Pre-commit Hook
```bash
#!/bin/sh
forge verify --strict
```

---

*Document Version: 2.0*


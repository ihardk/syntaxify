# Rollback & Recovery Strategy

> How to recover when generated code breaks production.

---

## 1. Prevention First

### 1.1 Generated File Headers
```dart
// ============================================================
// GENERATED BY Forge v1.2.3
// DO NOT EDIT MANUALLY
// 
// Source:   meta/button.meta.dart
// Theme:    material
// Generated: 2024-12-16T12:30:00Z
// Checksum:  a1b2c3d4
// ============================================================
```

### 1.2 Checksum Validation
```bash
$ forge verify

Verifying generated files...
✓ app_button.dart - OK
✓ app_badge.dart - OK
✗ app_card.dart - MODIFIED (local changes detected)

1 file has been manually modified.
Run 'forge build --force' to regenerate.
```

---

## 2. Backup Before Generation

### 2.1 Automatic Backup
```bash
$ forge build

Creating backup at .meta_backup/2024-12-16_123000/
Generating 4 components...
✓ Complete

To rollback: forge rollback --to=2024-12-16_123000
```

### 2.2 Backup Structure
```
.meta_backup/
├── 2024-12-16_123000/
│   ├── lib/components/app_button.dart
│   ├── lib/components/app_card.dart
│   └── manifest.json
└── 2024-12-15_090000/
    └── ...
```

---

## 3. Rollback Commands

### 3.1 Rollback to Previous
```bash
$ forge rollback

Available backups:
  1. 2024-12-16_123000 (latest)
  2. 2024-12-16_090000
  3. 2024-12-15_180000

Select backup [1]: 2

Rolling back to 2024-12-16_090000...
Restored 4 files.
```

### 3.2 Rollback Specific File
```bash
$ forge rollback --file=lib/components/app_button.dart
```

---

## 4. Git Integration

### 4.1 Pre-Commit Hook
```bash
#!/bin/sh
# .git/hooks/pre-commit

# Verify no modified generated files are committed
forge verify --strict
if [ $? -ne 0 ]; then
  echo "Error: Generated files have been manually modified."
  echo "Run 'forge build' to regenerate."
  exit 1
fi
```

### 4.2 Branch-Based Recovery
```bash
# Recovery via git
git checkout HEAD~1 -- lib/components/

# Or restore from a known good commit
git checkout abc123 -- lib/components/
```

---

## 5. Production Incident Recovery

### 5.1 Immediate Hotfix
```bash
# 1. Identify broken component
flutter analyze lib/components/

# 2. Manually patch (emergency only)
# Edit lib/components/app_button.dart

# 3. Deploy fix

# 4. Later: fix meta definition and regenerate
```

### 5.2 Safe Regeneration
```bash
# 1. Create safety branch
git checkout -b fix/meta-regenerate

# 2. Regenerate
forge build

# 3. Run tests
flutter test

# 4. If tests pass, merge
git checkout main && git merge fix/meta-regenerate
```

---

## 6. Version Compatibility

### 6.1 Generator Version Locking
```yaml
# pubspec.yaml
dev_dependencies:
  forge: 1.2.3  # Pin exact version
```

### 6.2 Schema Version in Meta
```yaml
# meta/button.meta.yaml
schema_version: 2
# ...
```

If generator version doesn't match schema:
```bash
ERROR: Schema version mismatch
  Expected: 2
  Generator supports: 1
  
Run 'forge update' to upgrade generator.
```

---

## 7. Disaster Recovery Checklist

- [ ] Stop deployment pipeline
- [ ] Identify failing component from stack trace
- [ ] Check `.meta_backup/` for last known good version
- [ ] Rollback specific file or entire `lib/components/`
- [ ] Run `flutter test` to verify
- [ ] If tests fail, rollback via `git`
- [ ] Deploy hotfix
- [ ] Post-mortem: update meta definition to fix root cause
- [ ] Regenerate and test before next deploy

---

## 8. Backup Retention Policy

| Environment | Retention |
|-------------|-----------|
| Local | Last 5 backups |
| CI | Last 10 builds |
| Production | Permanent via git tags |

```bash
$ forge config set backup.retention 10
```

---

*Document Version: 1.0*

